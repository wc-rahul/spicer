{% comment %}
  This is the cart drawer component.
{% endcomment %}

<script
  src="{{ 'cart-drawer.js' | asset_url }}"
  type="module"
></script>

<cart-drawer-component
  class="cart-drawer"
  {{ block.shopify_attributes }}
  {{ cart_drawer_sizes }}
  {% if settings.auto_open_cart_drawer %}
    auto-open
  {% endif %}
>
  <button
    class="button header-actions__action button-unstyled"
    on:click="/open"
    aria-label="{{ 'accessibility.open_cart_drawer' | t }} {{ 'accessibility.cart_count' | t}}: {{ cart.item_count }}"
  >
    {% render 'cart-icon-component' %}
  </button>

  <dialog
    ref="dialog"
    class="cart-drawer__dialog dialog-modal dialog-drawer color-{{ settings.drawer_color_scheme }}{% if cart.empty? %} cart-drawer--empty{%endif%}"
    scroll-lock
  >
    <div class="cart-drawer__inner">
      <cart-items-component
        class="cart-items-component"
        data-section-id="{{ section.id }}"
      >
        {%- if cart.empty? -%}
          <div class="cart-drawer__header">
            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          <div
            class="cart-drawer__content motion-reduce"
            aria-label="{{ 'accessibility.cart' | t }}"
          >
            <span class="cart-drawer__heading h3 cart-drawer__heading--empty">
              {{ 'content.your_cart_is_empty' | t }}
            </span>
            {% render 'cart-discounts-bar', theme_settings: true %}
            <div class="cart-drawer__items">
              {% render 'cart-products' %}
            </div>
          </div>
        {%- else -%}
          <div
            class="cart-drawer__header"
            id="cart-drawer-header"
          >
            <span class="cart-drawer__heading h3">
              {{ 'content.cart_title' | t }}
              {% render 'cart-bubble' %}
            </span>

            <button
              ref="closeButton"
              on:click="cart-drawer-component/close"
              class="button cart-drawer__close-button button-unstyled"
              aria-label="{{ 'actions.close_dialog' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'icon-close.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>

          <div
            class="cart-drawer__content motion-reduce"
            aria-label="{{ 'accessibility.cart' | t }}"
            style="--header-height: {{ section.settings.header_height | default: 60 }}px;"
          >
            {% render 'cart-discounts-bar', theme_settings: true %}
            <scroll-hint
              class="cart-drawer__items"
            >
              {% render 'cart-products' %}
            </scroll-hint>

            <div
              class="cart-drawer__summary"
            >
              {% render 'cart-summary' %}
            </div>
          </div>
        {%- endif -%}
      </cart-items-component>
    </div>
  </dialog>
</cart-drawer-component>

{% stylesheet %}
  .cart-items-component {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .cart-drawer__heading .cart-bubble {
    width: fit-content;
    border-radius: var(--style-border-radius-buttons-primary);
    aspect-ratio: auto;
    padding: var(--cart-padding);
  }

  .cart-drawer__heading .cart-bubble[data-maintain-ratio] {
    aspect-ratio: 1;
    min-width: 26px;
  }

  .cart-drawer__header {
    background-color: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--cart-drawer-padding);
    border-bottom: var(--style-border-width) solid none;
    position: sticky;
    top: 0;
    z-index: 1;

    @media screen and (width >= 750px) {
      padding: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer__dialog {
    overflow: hidden;
  }

  .cart-drawer__inner {
    height: 100%;
    overflow: hidden;
  }

  .cart-drawer__content {
    height: calc(100% - var(--header-height));
    display: flex;
    flex-direction: column;
  }

  .cart-drawer__summary {
    background-color: var(--color-background);
    position: sticky;
    bottom: 0;
    z-index: 1;
  }
{% endstylesheet %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const barSelector = '[data-cart-progress-bar]';
    const progressBar = document.querySelector(barSelector);
  
    if (!progressBar) return;
  

  
    const thresholds = [
      {
        value: parseFloat(progressBar.dataset.thresholdFirst || 0),
        discount: progressBar.dataset.thresholdFirstPercent || '0'
      },
      {
        value: parseFloat(progressBar.dataset.thresholdSecond || 0),
        discount: progressBar.dataset.thresholdSecondPercent || '0'
      },
      {
        value: parseFloat(progressBar.dataset.thresholdThird || 0),
        discount: progressBar.dataset.thresholdThirdPercent || '0'
      }
    ];
  
    const initial_message = document.querySelectorAll(".initial_message");

    
    function fetchCart() {
      return fetch('/cart.js').then(res => res.json());
    }
  
    function updateProgressBar(cart) {
  
      const stepElements = progressBar.querySelectorAll('.progress-step');
      const total = cart.items.reduce((sum, item) => {
        return item.product_type === 'Gift Card' ? sum : sum + item.original_line_price;
      }, 0) / 100;
  
      const maxThreshold = Math.max(...thresholds.map(t => t.value));
      const progressPercent = Math.min((total / maxThreshold) * 100, 100).toFixed(2);
  
      progressBar.style.setProperty('--progress-width', progressPercent + '%');
  
      const next = thresholds.find(t => t.value > total);
      const amountAwayEl = document.getElementById('amount-away');
      const amountAwayPercentEl = document.getElementById('amount-away_percent');
      const finalMessageEl = document.getElementById('final_message_progress_bar');
  
      if (next && amountAwayEl && amountAwayPercentEl) {
        amountAwayEl.innerText = `$${(next.value - total).toFixed(2)}`;
        amountAwayPercentEl.innerText = `${next.discount}`;
        if (finalMessageEl) finalMessageEl.style.display = 'none';
      } else if (finalMessageEl) {
        finalMessageEl.style.display = 'block';
        initial_message.forEach(msg => msg.style.display = 'none');
      }
  
      // Add/remove "completed" class
      stepElements.forEach((step, index) => {
        const threshold = thresholds[index];
        if (threshold) {
          if (total >= threshold.value) {
            step.classList.add('completed');
          } else {
            step.classList.remove('completed');
          }
        }
      });
    }
  
    function triggerUpdate() {
      fetchCart().then(updateProgressBar).catch(console.error);
    }
  
    // Hook into fetch() to catch all cart updates
    const originalFetch = window.fetch;
    window.fetch = function () {
      return originalFetch.apply(this, arguments).then(response => {
        const url = arguments[0];
        if (typeof url === 'string' && url.includes('/cart')) {
           setTimeout(triggerUpdate, 700); // optional
        }
        return response;
      });
    };
  
    // PerformanceObserver for cart changes
    function observeCartChanges() {
      const cartObserver = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          const isValidRequestType = ['xmlhttprequest', 'fetch'].includes(entry.initiatorType);
          const isCartChangeRequest = /\/cart\//.test(entry.name);
          if (isValidRequestType && isCartChangeRequest) {
            triggerUpdate();
          }
        });
      });
      cartObserver.observe({ entryTypes: ["resource"] });
    }
  
    observeCartChanges();
  
  
    document.addEventListener('cart:updated', () => {
      triggerUpdate();
    });
  
    // Initial trigger
    setTimeout(triggerUpdate, 300); // slight delay ensures DOM is ready
  });
  </script>
  
<script>
 

   document.addEventListener('DOMContentLoaded', () => { 

    function observeCartChanges() {
        const cartObserver = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
            const isValidRequestType = ['xmlhttprequest', 'fetch'].includes(entry.initiatorType);
            const isCartChangeRequest = /\/cart\//.test(entry.name);
            if (isValidRequestType && isCartChangeRequest) {
            // handle cart request

            //triggerUpdate();
            }
        });
        });
        cartObserver.observe({ entryTypes: ["resource"] });
    }
    observeCartChanges();
   });
  </script>